{#if open}
<div id="context-menu" class="popup" style="top:{y}px; left:{x}px;">
    {#each items as item, i}
    {#if item.divider}
    <ContextMenuDivider></ContextMenuDivider>
    {:else}
    <ContextMenuRow id={i} {...item} selected={selectedID===i} on:rowSelected={rowSelected} on:click={click}></ContextMenuRow>
    {/if}
    {/each}
</div>
{/if}


<style>
    #context-menu {
        z-index: 910;
        min-height: 2rem;
        min-width: 3rem;
        overflow-x: hidden;
        padding: .2rem 0;
        vertical-align: middle;
        margin-left: .1rem;
        margin-top: -.5rem;
    }

</style>

<script>
    import { beforeUpdate, onMount } from 'svelte'

    import g from '../lib/Globals'
    import ContextMenuRow from './ContextMenuRow.html'
    import ContextMenuDivider from './ContextMenuDivider.html'
    import EventDispatcherFactory from '../LayeredKeyboardControl/EventDispatcherFactory'
    
    export let open = false,
        x = 0,
        y = 0,
        items = [
            // {
            //     text: '',
            //     callback: () => {}
            // }
        ],
        selectedRow = null,
        target = null,
        closable = true,
        selectedID = -1
    
    $: g.app && g.app.$set({ popup: open ? g.contextMenu : null })
    
    $: {
        if (open) selectedID = -1
    }
    
    onMount(() => {
//        __this.keyEventHandler = EventDispatcherFactory({
//            target: this,
//        })
    })
    
    function rowSelected({ detail }) {
        const { id } = detail
        selectedID = id
    }
    
    function click({ detail }) {
        const { id } = detail
        open = false
        const { callback } = items[id]
        callback && callback(target)
    }

    // [svelte-upgrade warning]
    // beforeUpdate and afterUpdate handlers behave
    // differently to their v2 counterparts
    beforeUpdate(() => {
//        if (changed.open) {
//            if (current.open) {
//                try {
//                    g.activeEditor.completion.set({ open: false })
//                } catch (e) { /* do nothing */ }
//                g.pushFocus(this)
//            } else {
//                g.popFocus(this)
//            }
//        }
    })

    // [svelte-upgrade suggestion]
    // review these functions and remove unnecessary 'export' keywords
    export function move(nRows) {
        const currentIndex = rows.indexOf(selectedRow)
        const length = rows.length

        let targetIndex = currentIndex + nRows
        if (currentIndex === -1 && nRows < 0) targetIndex = length - 1
        else if (targetIndex >= length) targetIndex = length - 1
        else if (targetIndex < 0) targetIndex = 0

        const targetRow = rows[targetIndex]
        selectedRow = targetRow
    }

    export function enter(rowNumber) {
        const row = rowNumber ? rows[rowNumber - 1] : selectedRow
        if (row) row.click()
        else open = false
    }
</script>
