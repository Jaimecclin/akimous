{#if open}
<div id="context-menu" class="popup" style="top:{y}px; left:{x}px;">
    {#each items as item, i}
    {#if item.divider}
    <ContextMenuDivider></ContextMenuDivider>
    {:else}
    <ContextMenuRow id={i} bind:this={rows[i]} {...item} selected={selectedID===i} on:rowSelected={rowSelected} on:click={click}></ContextMenuRow>
    {/if}
    {/each}
</div>
{/if}


<style>
    #context-menu {
        z-index: 910;
        min-height: 2rem;
        min-width: 3rem;
        overflow-x: hidden;
        padding: .2rem 0;
        vertical-align: middle;
        margin-left: .1rem;
        margin-top: -.5rem;
    }

</style>

<script>
    import { onMount, tick } from 'svelte'

    import g from '../lib/Globals'
    import ContextMenuRow from './ContextMenuRow.html'
    import ContextMenuDivider from './ContextMenuDivider.html'
    import EventDispatcherFactory from '../LayeredKeyboardControl/EventDispatcherFactory'
    
    export let open = false,
        x = 0,
        y = 0,
        items = [
            // {
            //     text: '',
            //     callback: () => {}
            // }
        ],
        selectedRow = null,
        target = null,
        closable = true,
        selectedID = -1,
        keyEventHandler = null
    
    let rows = {}
    
    $: g.app && g.app.$set({ popup: open ? g.contextMenu : null })
    $: {
        if (open) {
            selectedID = -1
            try {
                g.activeEditor.completion.$set({ open: false })
            } catch (e) { /* do nothing */ }
            g.pushFocus(g.contextMenu)
        } else {
            g.popFocus(g.contextMenu)
        }
    }
        
    onMount(async () => {
        await tick()
        keyEventHandler = EventDispatcherFactory({
            target: g.contextMenu,
        })
    })
    
    function rowSelected({ detail }) {
        const { id } = detail
        selectedID = id
    }
    
    function click({ detail }) {
        const { id } = detail
        open = false
        const { callback } = items[id]
        callback && callback(target)
    }

    export function move(nRows) {
        const length = items.length
        let targetIndex = selectedID + nRows
        if (selectedID === -1 && nRows < 0) targetIndex = length - 1
        else if (targetIndex >= length) targetIndex = length - 1
        else if (targetIndex < 0) targetIndex = 0
        selectedID = targetIndex
    }

    export function enter(rowNumber) {
        const row = rowNumber ? rows[rowNumber - 1] : selectedRow
        if (row) row.click()
        else open = false
    }
</script>
