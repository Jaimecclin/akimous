{#if open}
<div ref:runConfiguration id="run-configuration" class="popup from-top" style="left: calc({left}px - 12.5rem);">
    <div class="container">
        <div class="title">Run Configuration</div>
        <div class="message">Choose a way to run your program.</div>
        <div class="title">Python Script</div>
        <TextInput bind:value=cwd on:change="saveChanges('cwd')" theme="bright" padded={false}>
            <span style="width: 8rem; display: inline-block;">Working directory: </span>
        </TextInput>
        <TextInput bind:value=args on:change="saveChanges('args')" theme="bright" padded={false}>
            <span style="width: 8rem; display: inline-block;">Arguments: </span>
        </TextInput>
        <div class="option" class:checked="mode==='script'" on:click="set({ mode: 'script' })">
            <i class="checkbox fas"/>
            <span class="description">Run current script</span>
        </div>
        <div class="option" class:checked="mode==='module'" on:click="set({ mode: 'module' })">
            <i class="checkbox fas"/>
            <span class="description">Run current script as module</span>
        </div>
        <div class="title with-button">
            Shell
            <ToggleButton ref:edit on:click="onClickEdit()">{ editing ? 'Done' : 'Edit' }</ToggleButton>
        </div>

        {#each shellCommands as command, i}
        <div class="option"  class:checked="shellCommandIndex===i && mode==='shell'" class:gone="i === shellCommands.length - 1 && !editing" on:click="set({ mode: 'shell', shellCommandIndex: i })">
            <i class="checkbox fas"/>
            <RunConfigShellCommand value={command} index={i} {shellCommands} {editing}></RunConfigShellCommand>
        </div>
        {/each}

        <div class="title">IPython</div>
        <div class="option" class:checked="mode==='interactive'" on:click="set({ mode: 'interactive' })">
            <i class="checkbox fas"/>
            <span class="description">Interactive shell</span>
        </div>
        <div class="option" class:checked="mode==='realtime'" on:click="set({ mode: 'realtime' })">
            <i class="checkbox fas"/>
            <span class="description">Realtime evaluation</span>
        </div>
    </div>
</div>
{/if}


<style>
    .run-now {
        flex-grow: 1;
        text-align: right;
        color: var(--primary5);
        display: none;
    }

    .option:hover .run-now {
        display: inline;
    }

    .shell-commands {
        padding: 0 1rem 0 2rem;
    }
    
    .checked .checkbox:before {
        content: "\f111";
    }

</style>


<script>
    import g from '../lib/Globals'
    import { setProjectState } from '../lib/ConfigManager'

    export default {
        components: {
            RunConfigShellCommand: './RunConfigShellCommand.html',
            ToggleButton: '../lib/ToggleButton.html',
            TextInput: '../lib/TextInput.html',
        },
        oncreate() {
            g.runConfiguration = this
        },
        onstate({ changed, current }) {
            if (!g.ready) return
            if (changed.open && g.toolbar) {
                g.app.set({
                    popup: current.open ? this : null
                })
            }
            if (changed.editing && this.refs.edit) {
                this.refs.edit.set({
                    active: current.editing
                })
            }
            if (changed.open && !current.open) {
                this.set({
                    editing: false
                })
            }
            if (changed.mode || changed.shellCommandIndex) {
                this.saveChanges()
            }
            if (changed.mode) {
                this.setConsoleMode()
            }
        },
        data() {
            return {
                open: false,
                left: 0,
                mode: 'script', // 'script', 'module', 'shell', 'interactive', 'realtime'
                editing: false,
                allowWhiteSpace: true,
                args: 'args',
                cwd: '',
                shellCommandIndex: 0,
                shellCommands: [
                    'python',
                    ''
                ]
            }
        },
        methods: {
            setConsoleMode() {
                const { mode } = this.get()
                if (['script', 'module', 'shell'].includes(mode)) {
                    g.console.set({ mode: 'terminal' })
                } else if (['interactive', 'realtime'].includes(mode)) {
                    g.console.set({ mode: 'jupyter' })
                    g.jupyterToolbar.set({ mode })
                }
                g.console.stop()
            },
            onClickEdit() {
                const { editing } = this.get()
                this.set({
                    editing: !editing
                })
            },
            saveChanges(what) {
                if (what) {
                    setProjectState('runConfiguration', {
                        [what]: this.get()[what]
                    })
                } else {
                    const { mode, shellCommands, shellCommandIndex } = this.get()
                    setProjectState('runConfiguration', {
                        mode,
                        shellCommands,
                        shellCommandIndex
                    })
                }
            },
        }
    }

</script>
