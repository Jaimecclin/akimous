{#if open}
<div ref:runConfiguration id="run-configuration" class="popup">
    <div class="container non-selectable">
        <div class="title">Run Configuration</div>
        <div class="message">Choose a way to run your program.</div>
        <div class="title">Python Script</div>
        <div class="option" on:click="set({ mode: 'script' })">
            <span class="checkbox">
                <i class="fa-circle { mode==='script'?'checked fas': 'far' }"></i>
            </span>
            <span class="description">Run current script</span>
            <span class="run-now" on:click="runNow('script')"><i class="fas fa-running"></i></span>
        </div>
        <div class="option" on:click="set({ mode: 'module' })">
            <span class="checkbox">
                <i class="fa-circle { mode==='module'?'checked fas': 'far' }"></i>
            </span>
            <span class="description">Run current script as module</span>
            <span class="run-now" on:click="runNow('module')"><i class="fas fa-running"></i></span>
        </div>
        <div class="title with-button">
            Shell
            <ToggleButton ref:edit on:click="onClickEdit()">{ editing ? 'Done' : 'Edit' }</ToggleButton>
        </div>

        {#each shellCommands as command, i}
        <div class="option" class:gone="i === shellCommands.length - 1 && !editing" on:click="set({ mode: 'shell', shellCommandIndex: i })">
            <span class="checkbox">
                <i class="fa-circle { (shellCommandIndex===i && mode==='shell') ? 'checked fas' : 'far' }"></i>
            </span>
            <RunConfigShellCommand value={command} index={i} {shellCommands} {editing}></RunConfigShellCommand>
            {#if !editing}
            <span class="run-now" on:click="runNow('shell', i)"><i class="fas fa-running"></i></span>
            {/if}
        </div>
        {/each}

        <div class="title">IPython</div>
        <div class="option" on:click="set({ mode: 'all' })">
            <span class="checkbox">
                <i class="fa-circle { mode==='all'?'checked fas': 'far' }"></i>
            </span>
            <span class="description">Run all</span>
            <span class="run-now" on:click="runNow('all')"><i class="fas fa-running"></i></span>
        </div>
        <div class="option" on:click="set({ mode: 'selected' })">
            <span class="checkbox">
                <i class="fa-circle { mode==='selected'?'checked fas': 'far' }"></i>
            </span>
            <span class="description">Run selected lines</span>
            <span class="run-now" on:click="runNow('selected')"><i class="fas fa-running"></i></span>
        </div>
        <div class="option" on:click="set({ mode: 'toLine' })">
            <span class="checkbox">
                <i class="fa-circle { mode==='toLine'?'checked fas': 'far' }"></i>
            </span>
            <span class="description">Run to selected line</span>
            <span class="run-now" on:click="runNow('toLine')"><i class="fas fa-running"></i></span>
        </div>
        <div class="option" on:click="set({ mode: 'playground' })">
            <span class="checkbox">
                <i class="fa-circle { mode==='playground'?'checked fas': 'far' }"></i>
            </span>
            <span class="description">Real-time evaluation</span>
            <span class="run-now" on:click="runNow('playground')"><i class="fas fa-running"></i></span>
        </div>
    </div>
</div>
{/if}


<style>
    #run-configuration {
        right: 8rem;
        top: calc(var(--toolbar-height) + 0.5rem);
        width: 24rem;
        min-height: 10rem;
        max-height: 40rem;
    }

    /* https://leaverou.github.io/bubbly/ */
    #run-configuration:after {
        content: '';
        position: absolute;
        top: 0;
        right: 12rem;
        width: 0;
        height: 0;
        border: 0.5rem solid transparent;
        border-bottom-color: var(--popup-bg-color);
        border-top: 0;
        margin-top: -0.5rem;
    }

    .container {
        min-height: 10rem;
        max-height: 39rem;
        overflow-y: scroll;
        margin: 0 0 1rem 0;
    }

    .title {
        color: var(--primary5);
        font-weight: 400;
        margin-top: 1.5rem;
        padding: 0 1.5rem .6rem 1.5rem;
    }

    .with-button {
        justify-content: space-between;
        display: flex;
    }

    .message {
        color: var(--gray7);
        padding-left: 1.5rem;
    }

    .option {
        display: flex;
        color: var(--gray5);
        padding: .6rem .4rem;
        margin: 0rem 1.5rem;
        font-size: var(--monospace-font-size);
        border-radius: var(--default-radius);
    }

    .option:hover {
        background: var(--primary8);

    }

    .checkbox {
        padding-left: .4rem;
        vertical-align: middle;
        color: var(--primary7);
    }

    .checked {
        color: var(--green);
    }

    .description {
        padding-left: .4rem;
        vertical-align: middle;
    }

    .option:hover .description {
        color: var(--primary3);
    }
    
    .option:hover .run-now {
        display: inline;
    }

    .run-now {
        flex-grow: 1;
        text-align: right;
        color: var(--primary5);
        display: none;
    }

    .shell-commands {
        padding: 0 1rem 0 2rem;
    }

</style>


<script>
    import g from '../lib/Globals'
    import { setProjectConfig } from '../lib/ConfigManager'

    export default {
        components: {
            RunConfigShellCommand: './RunConfigShellCommand.html',
            ToggleButton: '../lib/ToggleButton.html',
        },
        oncreate() {
            g.runConfiguration = this
        },
        onstate({ changed, current }) {
            if (changed.open && g.toolbar) {
                g.app.set({
                    popup: current.open ? this : null
                })
            }
            if (changed.editing && this.refs.edit) {
                this.refs.edit.set({
                    active: current.editing
                })
            }
            if (changed.open && !current.open) {
                this.set({
                    editing: false
                })
            }
        },
        data() {
            return {
                open: false,
                mode: 'script',
                editing: false,
                allowWhiteSpace: true,
                shellCommandIndex: 0,
                shellCommands: [
                    'python',
                    ''
                ]
            }
        },
        methods: {
            onClickEdit() {
                const { editing } = this.get()
                this.set({
                    editing: !editing
                })
            },
            saveChanges() {
                const { mode, shellCommands } = this.get()
                setProjectConfig('runConfiguration', {
                    mode,
                    shellCommands
                })
            },
            runNow(mode, shellCommandIndex = 0) {
                const originalSetting = this.get()
                this.set({ mode, shellCommandIndex }) // set temporarily
                
                g.console.runInTerminal()
                originalSetting.open = false
                this.set(originalSetting) // restore original and close
                event.stopPropagation()
            }
        }
    }

</script>
