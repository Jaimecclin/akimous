{#if open}
<div id="run-configuration" class="popup from-top" style="left: calc({left}px - 12.5rem);">
    <div class="container">
        <div class="title">Run Configuration</div>
        <div class="message">Choose a way to run your program.</div>
        <div class="title">Python Script</div>
        <TextInput bind:value={cwd} on:change="{() => saveChanges('cwd')}" theme="bright" padded={false}>
            <span style="width: 8rem; display: inline-block;">Working directory: </span>
        </TextInput>
        <TextInput bind:value={args} on:change="{() => saveChanges('args')}" theme="bright" padded={false}>
            <span style="width: 8rem; display: inline-block;">Arguments: </span>
        </TextInput>
        <div class="option" class:checked="{mode==='script'}" on:click="{() => mode = 'script'}">
            <i class="checkbox fas"/>
            <span class="description">Run current script</span>
        </div>
        <div class="option" class:checked="{mode==='module'}" on:click="{() => mode = 'module'}">
            <i class="checkbox fas"/>
            <span class="description">Run current script as module</span>
        </div>
        <div class="title with-button">
            Shell
            <ToggleButton on:click="{onClickEdit}">{ editing ? 'Done' : 'Edit' }</ToggleButton>
        </div>

        {#each shellCommands as command, i}
        <div class="option"  class:checked="{shellCommandIndex===i && mode==='shell'}" class:gone="{i === shellCommands.length - 1 && !editing}" on:click="{() => mode = 'shell', shellCommandIndex = i}">
            <i class="checkbox fas"/>
            <RunConfigShellCommand value={command} index={i} {shellCommands} {editing}></RunConfigShellCommand>
        </div>
        {/each}

        <div class="title">IPython</div>
        <div class="option" class:checked="{mode==='interactive'}" on:click="{() => mode = 'interactive'}">
            <i class="checkbox fas"/>
            <span class="description">Interactive shell</span>
        </div>
        <div class="option" class:checked="{mode==='realtime'}" on:click="{() => mode = 'realtime'}">
            <i class="checkbox fas"/>
            <span class="description">Realtime evaluation</span>
        </div>
    </div>
</div>
{/if}


<style>
    .run-now {
        flex-grow: 1;
        text-align: right;
        color: var(--primary5);
        display: none;
    }

    .option:hover .run-now {
        display: inline;
    }

    .shell-commands {
        padding: 0 1rem 0 2rem;
    }
    
    .checked .checkbox:before {
        content: "\f111";
    }

</style>

   
<script>
    import { beforeUpdate } from 'svelte'

    import g from '../lib/Globals'
    import { setProjectState } from '../lib/ConfigManager'
    import { capitalize, nextFrame } from '../lib/Utils'
    
    import RunConfigShellCommand from './RunConfigShellCommand.html'
    import ToggleButton from '../lib/ToggleButton.html'
    import TextInput from '../lib/TextInput.html'
    
    // [svelte-upgrade suggestion]
    // manually refactor all references to __this
    const __this = {
        get: () => ({ open, left, cwd, args, mode, editing, shellCommands, shellCommandIndex, allowWhiteSpace })
    }

    export let open = false,
        left = 0,
        cwd = '',
        args = 'args',
        mode = 'script',
        editing = false,
        shellCommands = [
            'python',
            ''
        ],
        shellCommandIndex = 0,
        allowWhiteSpace = true

    // [svelte-upgrade warning]
    // beforeUpdate and afterUpdate handlers behave
    // differently to their v2 counterparts
    beforeUpdate(() => {
//        if (changed.mode) {
//            nextFrame(() => {
//                g.toolbar.set({
//                    runConfigurationDisplay: capitalize(current.mode)
//                })
//            })
//        }
//        if (!g.ready) return
//        if (changed.open && g.toolbar) {
//            g.app.set({
//                popup: current.open ? this : null
//            })
//        }
//        if (changed.editing && edit) {
//            edit.set({
//                active: current.editing
//            })
//        }
//        if (changed.open && !current.open) {
//            editing = false
//        }
//        if (changed.mode || changed.shellCommandIndex) {
//            saveChanges()
//        }
//        if (changed.mode) {
//            setConsoleMode()
//        }
    })

    // [svelte-upgrade suggestion]
    // review these functions and remove unnecessary 'export' keywords
    export function setConsoleMode() {
        if (['script', 'module', 'shell'].includes(mode)) {
            g.console.set({ mode: 'terminal' })
        } else if (['interactive', 'realtime'].includes(mode)) {
            g.console.set({ mode: 'jupyter' })
            g.jupyterToolbar.set({ mode })
        }
        g.console.stop()
    }

    export function onClickEdit() {
        editing = !editing
    }

    export function saveChanges(what) {
        if (what) {
            setProjectState('runConfiguration', {
                [what]: __this.get()[what]
            })
        } else {
            setProjectState('runConfiguration', {
                mode,
                shellCommands,
                shellCommandIndex
            })
        }
    }
</script>
