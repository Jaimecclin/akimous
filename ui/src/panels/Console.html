<div class="panel" class:gone="!active">
    {#if mode === 'terminal'}
    <div ref:terminal class="tab-view"></div>
    {:elseif mode === 'jupyter'}
    <div ref:jupyter class="tab-view">
        <JupyterToolbar ref:jupyterToolbar></JupyterToolbar>
        <table id="jupyter-cells">
            {#each cells as cell}
            {#if displayInput || !cell.code }
            <JupyterCell {...cell}></JupyterCell>
            {/if}
            {/each}
        </table>
    </div>
    {/if}
</div>


<style>

</style>


<script>
    import g from '../lib/Globals'
    import { initializeTabView, nextFrame } from '../lib/Utils'
    import Terminal from 'xterm/dist/xterm'
    import fit from 'xterm/lib/addons/fit/fit'
    import { Socket } from '../lib/Socket'

    Terminal.applyAddon(fit)

    export default {
        components: {
            JupyterToolbar: './JupyterToolbar.html',
            JupyterCell: './JupyterCell.html',
        },
        oncreate() {
            g.console = this
            initializeTabView(this, 'Console', 'fas fa-desktop l-purple')

        },
        onupdate({ changed, current }) {
            if (changed.mode) {
                this.close()
                if (current.active) {
                    this.initialize()
                }
            }
            if (changed.active) {
                if (!current.ready && current.active) {
                    this.initialize()
                }
            }
        },
        data() {
            return {
                active: false,
                mode: '', // 'terminal' or 'jupyter'
                ready: false,
                cells: [
                    // {
                    //     output: {
                    //         'text/plain': 'text',
                    //     }
                    // }
                ],
                displayInput: false,
            }
        },
        methods: {
            initialize() {
                const { mode } = this.get()
                if (mode === 'terminal') {
                    this.tab.set({ active: false })
                    this.tab.set({ active: true })
                    nextFrame(() => this.openTerminal())
                } else if (mode === 'jupyter') {
                    this.openJupyter()
                }
            },
            close() {
                this.set({ ready: false })
                if (this.socket) {
                    this.socket.close()
                    this.socket = null
                }
                if (this.terminal) {
                    this.terminal.dispose()
                    this.terminal = null
                }
            },
            runDefault() {
                const { mode } = this.get()
                if (mode === 'terminal') {
                    this.runInTerminal()
                } else if (mode === 'jupyter') {
                    this.runInJupyter()
                }
            },

            // Terminal
            openTerminal() {
                const rem = parseFloat(getComputedStyle(document.documentElement).fontSize)
                const terminal = new Terminal({
                    tabStopWidth: 4,
                    fontSize: 1.2 * rem,
                    fontFamily: 'Source Code Pro',
                    fontWeight: 400, // workaround for broken block (e.g. tqdm) rendering
                    theme: {
                        foreground: '#CCC',
                        background: '#3F3F3F'
                    },
                    convertEol: true,
                })
                this.terminal = terminal
                terminal.open(this.refs.terminal, false)
                terminal.on('focus', () => {
                    g.setFocus([g.panelRight, this])
                })
                terminal.addDisposableListener('data', data => {
                    this.socket.send('Stdin', data)
                })

                this.socket = new Socket('terminal')
                    .addHandler('Stdout', message => {
                        terminal.write(message)
                    })
                    .addHandler('Started', () => {
                        terminal.clear()
                        terminal.reset()
                    })
                    .connect(() => {})

                nextFrame(() => {
                    this.terminal.fit()
                    terminal.write('Click "Run" on toolbar to run current script.\n')
                    this.set({ ready: true })
                })
            },

            runInTerminal() {
                g.panelRight.activateView(g.panelRight.refs.console)
                const { mode, shellCommands, shellCommandIndex, args, cwd } = g.runConfiguration.get()

                const run = () => {
                    const { ready } = this.get()
                    if (!ready) {
                        nextFrame(run)
                        return
                    }
                    const { cols, rows } = this.terminal
                    this.terminal.clear()

                    const configuration = { mode, cols, rows }
                    if (mode === 'shell') {
                        configuration.command = shellCommands[shellCommandIndex]
                    } else {
                        const { filePath } = g.activeEditor.get()
                        configuration.filePath = filePath
                    }
                    if (mode === 'script' || mode === 'module') {
                        configuration.args = args
                        configuration.cwd = cwd
                    }
                    this.socket.send('RunInTerminal', configuration)
                }

                run()
            },
            stop() {
                this.socket.send('Stop', {})
            },

            // Jupyter
            openJupyter() {
                this.socket = new Socket('jupyter')
                    .addHandler('KernelStarted', () => {
                        this.set({ ready: true })
                    })
                    .addHandler('IOPub', e => {
                        const { cells } = this.get()
                        const { execution_state } = e
                        if (execution_state) {
                            const { jupyterToolbar } = this.refs
                            if (execution_state === 'busy') jupyterToolbar.set({ busy: true })
                            else if (execution_state === 'idle') jupyterToolbar.set({ busy: false })
                        }
                        if (e.code) {
                            cells.push({
                                code: e.code,
                                executionCount: e.execution_count,
                            })
                            this.set({ cells })
                        }
                        if (e.name && e.text) {
                            cells.push({
                                [e.name]: e.text
                            })
                            this.set({ cells })
                        }
                        if (e.data) {
                            cells.push({
                                output: e.data,
                                executionCount: e.execution_count,
                            })
                            this.set({ cells })
                        }
                    })
                    .connect(() => {
                        this.socket.send('StartKernel')
                    })
            },
            runInJupyter() {
                g.panelRight.activateView(g.panelRight.refs.console)

                const run = () => {
                    const { ready } = this.get()
                    if (!ready) {
                        nextFrame(run)
                        return
                    }
                    this.socket.send('Run', {
                        code: g.activeEditor.cm.getSelection()
                    })
                }

                run()
            },
        }
    }

</script>
