<div class="panel" class:gone="!active">
    <div ref:terminal class="tab-view"></div>
</div>


<style>

</style>


<script>
    import g from '../lib/Globals'
    import { initializeTabView, nextFrame } from '../lib/Utils'
    import Terminal from 'xterm/dist/xterm'
    import fit from 'xterm/lib/addons/fit/fit'
    import { Socket } from '../lib/Socket'

    export default {
        components: {},
        oncreate() {
            g.console = this
            initializeTabView(this, 'Console', 'fas fa-desktop l-purple')
            this.initialized = false
        },
        onupdate({ changed, current }) {
            if (changed.active) {
                if (!this.initialized && current.active) {
                    this.initializeTerminal()
                }
            }
        },
        data() {
            return {
                active: false
            }
        },
        methods: {
            initializeTerminal() {
                this.tab.set({ active: false })
                this.tab.set({ active: true })

                nextFrame(() => {
                    Terminal.applyAddon(fit)
                    const rem = parseFloat(getComputedStyle(document.documentElement).fontSize)
                    const terminal = new Terminal({
                        tabStopWidth: 4,
                        fontSize: 1.2 * rem,
                        fontFamily: 'Source Code Pro',
                        fontWeight: 400, // workaround for broken block (e.g. tqdm) rendering
                        theme: {
                            foreground: '#CCC',
                            background: '#3F3F3F'
                        },
                        convertEol: true,
                    })
                    this.terminal = terminal
                    terminal.open(this.refs.terminal, false)
                    terminal.on('focus', () => {
                        g.setFocus([g.panelRight, this])
                    })
                    terminal.addDisposableListener('data', data => {
                        this.socket.send('Stdin', data)
                    })

                    this.socket = new Socket('terminal')
                        .addHandler('Stdout', message => {
                            terminal.write(message)
                        })
                        .addHandler('Started', () => {
                            terminal.clear()
                            terminal.reset()
                        })
                        .connect(() => {})

                    nextFrame(() => {
                        this.terminal.fit()
                        terminal.write('Click "Run" on toolbar to run current script.\n')
                        this.initialized = true
                    })
                })
            },
            runInTerminal() {
                g.panelRight.activateView(g.panelRight.refs.console)
                const { mode, shellCommands, shellCommandIndex } = g.runConfiguration.get()
                
                const run = () => {
                    const { initialized } = this
                    if (!initialized) {
                        nextFrame(run)
                        return
                    }
                    const { cols, rows } = this.terminal
                    this.terminal.clear()
                    
                    const configuration = { mode, cols, rows }
                    if (mode === 'shell') {
                        configuration.command = shellCommands[shellCommandIndex]
                    } else {
                        const { filePath } = g.activeEditor.get()
                        configuration.filePath = filePath
                    }
                    this.socket.send('RunInTerminal', configuration)
                }

                run()
            },
            stop() {
                this.socket.send('Stop', {})
            }
        }
    }

</script>
