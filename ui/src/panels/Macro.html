<div class="panel" class:gone="!active">
    <div ref:macro id="macro">
        <div class="title">Clipboard</div>
        <table id="clipboard" class="non-selectable">
            {#each clipboard as text, i}
            <tr on:click="paste(text)" on:mouseover="showPopup(i, event)" on:mouseleave="closePopup(event)">
                <td class="clipboard-index">{(i+1)%10}</td>
                <td>
                    <div class="clipboard-text">{text}</div>
                </td>
            </tr>
            {:else}
            <tr>
                <td class="placeholder">Empty <br>(copy or cut something to fill in the clipboard)</td>
            </tr>
            {/each}
        </table>

        <div class="title">Macros</div>
        <TextInput bind:value=macroFormat>Print format with shift: </TextInput>
        <table id="macros" class="non-selectable">
            {#each Object.entries(macros) as [hotkey, macro]}
            <tr on:click="executeMacro(macro, event)">
                <td class="macro-hotkey">{hotkey.toUpperCase()}</td>
                <td class="macro-name">
                    {macro.name}
                </td>
            </tr>
            {/each}
        </table>
    </div>
</div>

<style>
    #clipboard {
        width: 100%;
        background: var(--main-bg-color);
        font-family: var(--monospace-font-family);
    }

    .clipboard-index {
        width: 1rem;
        padding: .3rem;
        text-align: center;
        color: var(--ui-font-color);
        background: var(--primary3);
    }

    .clipboard-text {
        padding: .3rem;
        max-height: 3.8rem;
        white-space: pre;
        overflow: hidden;
        background: var(--gray2);
    }

    .macro-hotkey {
        width: 2rem;
        padding: .3rem 0;
        text-align: center;
        color: var(--ui-font-color);
        background: var(--primary2);
        font-family: var(--monospace-font-family);
    }

    .macro {
        padding: .3rem 0;
    }

    .macro-hotkey {
        width: 2rem;
        padding: .3rem 0;
        text-align: center;
        color: var(--ui-font-color);
        background: var(--primary2);
        font-family: var(--monospace-font-family);
    }

    .macro-name {
        padding: .4rem 0 .2rem .3rem;
        background: var(--gray2);
    }

</style>


<script>
    import g from '../lib/Globals'
    import { initializeTabView, schedule } from '../lib/Utils'

    export default {
        components: {
            TextInput: '../lib/TextInput.html'
        },
        oncreate() {
            g.macro = this
            initializeTabView(this, 'Macro', 'fas fa-magic l-orange')

            const macros = {}
            import('./macros.js').then(({ default: m }) => {
                for (const macro of m) {
                    macros[macro.hotkey] = macro
                }
                this.set({ macros })
                console.info(macros)
            })
        },
        data() {
            return {
                active: false,
                clipboard: [],
                macros: {},
                macroFormat: '${NAME} ='
            }
        },
        methods: {
            addClipboardItem(text) {
                const { clipboard } = this.get()
                if (clipboard.length >= 10) clipboard.pop()
                clipboard.unshift(text)
                this.set({
                    clipboard
                })
            },
            paste(text) {
                const editor = g.activeEditor
                if (!editor) return
                editor.cm.replaceSelection(text)
                editor.cm.focus()
            },
            dispatchMacro(event) {
                const key = event.key
                let number = +key
                if (Number.isInteger(number)) {
                    if (number === 0) number = 10
                    this.paste(this.get().clipboard[number - 1])
                } else {
                    const f = this.get().macros[key.toLowerCase()]
                    if (f)
                        f.callback(g.activeEditor.cm, event, this)
                }
            },
            showPopup(i, event) {
                const { x, y, height } = event.currentTarget.getBoundingClientRect()
                const content = this.get().clipboard[i]
                g.popup.set({
                    open: true,
                    content: `<div class="code">${content}</div>`
                })
                g.popup.reposition(x, y + height / 2)
            },
            closePopup(event) {
                g.popup.closeIfNotHovered(event)
            },
            executeMacro(macro) {
                macro.callback(g.activeEditor.cm, event, this)
            },
        }
    }

</script>
