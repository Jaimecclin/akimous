<script>
    import { onMount, createEventDispatcher } from 'svelte'
    
    import g from '../lib/Globals'
    import { schedule } from '../lib/Utils'
    import { makeScrollable } from '../lib/UIUtils'
    import { config, setConfig } from '../lib/ConfigManager'
    
    import TextInput from '../lib/TextInput.html'

    // [svelte-upgrade suggestion]
    // manually refactor all references to __this
    const __this = {
        get: () => ({ active, clipboard, macroFormatWithShift, macros, allowWhiteSpace })
    }
    const dispatch = createEventDispatcher()

    export let panel,
        active = false,
        clipboard = [],
        macroFormatWithShift = '${NAME} =',
        macros = {},
        allowWhiteSpace = true
    
    $: {
        dispatch('active', {
            id: 'Macro',
            active
        })
    }
    
    onMount(() => {
        __this.name = 'macro'
//        g.macro = this
//        initializeTabView(this, 'Macro', 'fas fa-magic l-orange')

        // load config
        const { macroFormatWithShift } = config.macro
        macroFormatWithShift = macroFormatWithShift

        // load macros
        const macros = {}
        import('/macro.js').then(({ default: defaultMacros }) => {
            for (const macro of defaultMacros) {
                macros[macro.hotkey] = macro
            }
            import('/user/macro.js').then(({ default: userMacros }) => {
                for (const macro of userMacros) {
                    macros[macro.hotkey] = macro
                }
            }).finally(() => {
                macros = macros
            })
        })

//        makeScrollable(this, panel)
    })

    // [svelte-upgrade suggestion]
    // review these functions and remove unnecessary 'export' keywords
    export function onFocus() {
        g.setFocus([g.panelRight, this])
    }

    export function addClipboardItem(text) {
        if (clipboard.length >= 10) clipboard.pop()
        clipboard.unshift(text)
        clipboard = clipboard
    }

    export function paste(text) {
        const editor = g.activeEditor
        if (!editor) return
        editor.cm.replaceSelection(text)
        editor.cm.focus()
    }

    export function dispatchMacro(event) {
        const key = event.key
        let number = +key
        if (Number.isInteger(number)) {
            if (number === 0) number = 10
            paste(__this.get().clipboard[number - 1])
        } else {
            const f = __this.get().macros[key.toLowerCase()]
            if (f)
                f.callback(g.activeEditor.cm, event, this)
        }
    }

    export function showPopup(i, event) {
        const { x, y, height } = event.currentTarget.getBoundingClientRect()
        const content = __this.get().clipboard[i]
        g.popup.set({
            open: true,
            content: `<div class="code">${content}</div>`
        })
        g.popup.reposition(x, y + height / 2)
    }

    export function closePopup(event) {
        g.popup.closeIfNotHovered(event)
    }

    export function executeMacro(macro) {
        macro.callback(g.activeEditor.cm, event, this)
    }

    export function onChangeMacroFormat() {
        setConfig('macro', {
            macroFormatWithShift: __this.get().macroFormatWithShift
        })
    }

    export function editMacro() {
        const path = config.macro.userMacroFile
        g.panelMiddle.openFile(path)
    }
</script>

<div bind:this={panel} id="macro" class="panel" class:gone="{!active}" on:click="{onFocus}">
    <div class="title">Clipboard</div>
    <table id="clipboard" class="non-selectable">
        {#each clipboard as text, i}
        <tr on:click="{() => paste(text)}" on:mouseover="{event => showPopup(i, event)}" on:mouseleave="{closePopup}">
            <td class="clipboard-index">{(i+1)%10}</td>
            <td>
                <div class="clipboard-text">{text}</div>
            </td>
        </tr>
        {:else}
        <tr>
            <td class="placeholder">Empty <br>(copy or cut something to fill in the clipboard)</td>
        </tr>
        {/each}
    </table>

    <div class="title">Macros<i class="edit-icon fas fa-edit" on:click="{editMacro}"></i></div>
    <TextInput bind:this={macroFormatWithShift} bind:value={macroFormatWithShift} on:change="{onChangeMacroFormat}">Print format with shift:&nbsp;</TextInput>
    <table id="macros" class="non-selectable">
        {#each Object.entries(macros).sort() as [hotkey, macro]}
        <tr on:click="{event => executeMacro(macro, event)}">
            <td class="macro-hotkey">{hotkey.toUpperCase()}</td>
            <td class="macro-name">
                {macro.name}
            </td>
        </tr>
        {/each}
    </table>
</div>

<style>
    #clipboard {
        width: 100%;
        background: var(--main-bg-color);
        font-family: var(--monospace-font-family);
    }

    .clipboard-index {
        width: 1rem;
        padding: .3rem;
        text-align: center;
        color: var(--ui-font-color);
        background: var(--primary3);
    }

    .clipboard-text {
        padding: .3rem;
        max-height: 3.8rem;
        white-space: pre;
        overflow: hidden;
        background: var(--gray2);
    }

    .macro-hotkey {
        width: 2rem;
        padding: .3rem 0;
        text-align: center;
        color: var(--ui-font-color);
        background: var(--primary2);
        font-family: var(--monospace-font-family);
    }

    .macro {
        padding: .3rem 0;
    }

    .edit-icon {
        font-size: var(--ui-font-size-small);
        text-align: right;
        flex-grow: 1;
        color: var(--basic-ui-font-color);
        padding-top: .7rem;
    }

    .edit-icon:hover {
        filter: brightness(1.2);
    }

    .macro-name {
        padding: .4rem 0 .2rem .3rem;
        background: var(--gray2);
    }

</style>
