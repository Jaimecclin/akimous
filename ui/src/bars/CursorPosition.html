<div id="indent-indicator" class="non-selectable">
    <span bind:this={indentSwitch} on:click="{switchIndent}" class="tool-bar-button" aria-label="Click to switch between tabs/spaces.">{isMakefile ? 'Tab Size' : indentDisplay}</span>:
    {#if editingIndentSize}
    <input bind:this={indentSizeInput} id="indent-size-input" type="number" max=12 min=1 step=1 on:blur="{commitIndentSize}" value={indentSize}>
    {:else}
    <span on:click="{editIndentSize}" class="tool-bar-button" aria-label="Click to edit indent size.">{indentSize}</span>
    {/if}
</div>
<div bind:this={cursorPosition} id="cursor-position" class="non-selectable tool-bar-button" aria-label="Cursor Position (line : column)"> {line+1} : {ch} </div>

<style>
    #cursor-position,
    #indent-indicator {
        position: relative;
        display: inline-block;
        text-align: center;
        font-size: var(--ui-font-size-small);
        flex-shrink: 0;
    }

    #cursor-position {
        width: 4rem;
    }

    #indent-indicator {
        width: 6rem;
    }

    #indent-size-input {
        width: 2rem;
    }

</style>
   

<script>
    import { beforeUpdate, onMount } from 'svelte'
    
    import g from '../lib/Globals'
    import { schedule } from '../lib/Utils'

    export let indentWithTabs = false,
        isMakefile = false,
        editingIndentSize = false,
        indentSize = 4,
        line = 0,
        ch = 0
    
    $: indentDisplay = indentWithTabs ? 'Tab Size' : 'Spaces'
    
    let indentSwitch,
        indentSizeInput,
        cursorPosition

    onMount(() => {
//        schedule(() => {
//            g.tooltip.register([
//                indentSwitch,
//                cursorPosition,
//            ])
//        })
    })

    // [svelte-upgrade warning]
    // beforeUpdate and afterUpdate handlers behave
    // differently to their v2 counterparts
//    beforeUpdate(() => {
//        if (changed.editingIndentSize && !current.editingIndentSize) {
//            schedule(() => {
//                g.tooltip.register(indentSize)
//            })
//        }
//    });

    // [svelte-upgrade suggestion]
    // review these functions and remove unnecessary 'export' keywords
    export function switchIndent() {
        if (isMakefile) return
        indentWithTabs = !indentWithTabs
        for (const path in g.panelMiddle.pathToEditor) {
            const editor = g.panelMiddle.pathToEditor[path]
            if (!editor.get().isMakefile)
                editor.cm.setOption('indentWithTabs', indentWithTabs)
        }
    }

    export function editIndentSize() {
        editingIndentSize = true
        requestAnimationFrame(() => {
            indentSizeInput.focus()
        })
    }

    export function commitIndentSize() {
        const indentSize = indentSizeInput.value
        editingIndentSize = false
        for (const path in g.panelMiddle.pathToEditor) {
            const editor = g.panelMiddle.pathToEditor[path]
            editor.cm.setOption('indentUnit', indentSize)
        }
    }
</script>
