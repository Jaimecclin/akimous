<script>
    import { beforeUpdate, onMount } from 'svelte';

    export let pathIndicator;

    import g from '../lib/Globals'
    import { schedule } from '../lib/Utils'
    import throttle from 'lodash.throttle'


    export let display = '';
    export let path = [];
    export let availableWidth = 0;

    onMount(() => {
        g.pathIndicator = this
        const setAvailableWidth = () => {
            availableWidth = this.refs.pathIndicator.getBoundingClientRect().width
        }
        window.addEventListener('resize', throttle(setAvailableWidth))
        setAvailableWidth()
    });

    // [svelte-upgrade warning]
    // beforeUpdate and afterUpdate handlers behave
    // differently to their v2 counterparts
    beforeUpdate(() => {
        if (changed.path || changed.availableWidth) {
            schedule(() => {
                display = this.fitWidth()
            })
        }
    });

    // [svelte-upgrade suggestion]
    // review these functions and remove unnecessary 'export' keywords
    export function fitWidth() {
        if (!path || path.length === 0) return ''
        
        if (!g.hiddenCanvas) g.hiddenCanvas = document.createElement('canvas')
        const context = g.hiddenCanvas.getContext('2d')
        const style = window.getComputedStyle(pathIndicator, null)
        context.font = `${style.getPropertyValue('font-weight')} ${style.getPropertyValue('font-size')} ${style.getPropertyValue('font-family')}`

        if (path[0] === g.pathSeparator) { // remove duplicated /
            path = path.slice(0)
            path[0] = ''
        }
        
        const full = path.join(g.pathSeparator)
        let measuredWidth = context.measureText(full).width
        if (measuredWidth < availableWidth - 10) return full

        const short = path[path.length - 1]
        measuredWidth = context.measureText(short).width
        if (measuredWidth < availableWidth - 10) return short
        
        return ''
    }
</script>

<div bind:this={pathIndicator} id="path-indicator">
    {display}
</div>

<style>
    #path-indicator {
        display: inline-block;
        text-align: center;
        font-size: var(--ui-font-size-small);
        flex-grow: 1;
        flex-shrink: 1;
        flex-basis: 0;
        min-width: 0;
        overflow: hidden;
        user-select: text;
        color: var(--primary7);
    }

</style>
