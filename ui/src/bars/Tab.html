<script>
    import { beforeUpdate, onDestroy, onMount } from 'svelte';

    // [svelte-upgrade suggestion]
    // manually refactor all references to __this
    const __this = {
        get: () => ({ active, clean, padding, name, icon, labeled, parent, view, panel })
    };

    export let tab;
    export let text;

    import g from '../lib/Globals'

    export let active = false;
    export let clean = true;
    export let padding = 0;
    export let name = '';
    export let icon = 'l-python-icon';
    export let labeled = true;
    export let parent = null;
    export let view = null;
    export let panel = null;

    onMount(() => {
//        __this.get().parent.tabs.add(this)
    });

    onDestroy(() => {
        parent.tabs.delete(this)
        parent.fitTabWidth()
    });

    // [svelte-upgrade warning]
    // beforeUpdate and afterUpdate handlers behave
    // differently to their v2 counterparts
    beforeUpdate(() => {
//        if (!previous) return
//        if (changed.parent) {
//            previous.parent && previous.parent.tabs.delete(this)
//            current.parent && current.parent.tabs.add(this)
//        }
    });

    // [svelte-upgrade suggestion]
    // review these functions and remove unnecessary 'export' keywords
    export function activate() {
        __this.get().panel.activateView(__this.get().view)
    }

    export function close() {
        __this.get().panel.closeView(__this.get().view)
    }

    export function mouseEnter() {
        if (padding && labeled)
            return
        g.tooltip.mouseEnterListener(event)
    }

    export function mouseLeave() {
        g.tooltip.mouseLeaveListener(event)
    }

    export function getIndex() {
        let node = tab
        let index = 0
        while (node) {
            index++
            node = node.previousElementSibling
        }
        return index
    }

    export function getInternalWidth() {
        const textWidth = text ? text.scrollWidth : 0
        return icon.scrollWidth + textWidth
    }

    export function forceSetWidth(x) {
        padding = 0
        tab.style.width = `${x}px`
    }

    export function autoWidth() {
        tab.style.width = ''
    }
</script>

<span bind:this={tab} class="tab non-selectable {active ? 'active' : ''} {clean ? '' : 'dirty'}" style="padding:0 {padding}px" on:click="{activate}" on:dblclick="{close}" on:mouseenter="{mouseEnter}" on:mouseleave="{mouseLeave}" aria-label="{name}">
    <!-- if the two spans sitting on different lines means there is a space in between-->
    <span bind:this={icon} class="icon {icon}" class:icon-height-adjustment="{name}"></span>{#if labeled}<span bind:this={text} class="text">{name}</span>{/if}
</span>


<style>
    .tab {
        border-right: 1px solid var(--panel-delimiter-color);
        height: var(--tab-bar-height);
        display: inline-block;
        overflow-x: visible;
        line-height: var(--tab-bar-height);
        background: var(--panel-color);
    }

    .icon {
        position: relative;
        width: 1rem;
        min-height: 1rem;
        display: inline-block;
        background-size: 100% 100% !important;
    }

    .icon-height-adjustment {
        vertical-align: -5%;
    }
    
    .active {
        background: linear-gradient(to bottom, var(--panel-color) 0%, var(--panel-color) 90%,
            var(--ui-highlight-color) 90%, var(--ui-highlight-color) 100%);
    }

    .text {
        display: inline-block;
        padding-left: .3rem;
    }
    
    .dirty .text {
        color: var(--ui-danger-color) !important;
    }
    
    .active .text {
        color: var(--brighter-ui-font-color);
    }

    .tab:hover .text {
        color: white;
    }

    .active:hover .text {
        color: white;
    }


</style>
