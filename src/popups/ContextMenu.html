<div ref:contextMenu id="context-menu" style="display:{open?'block':'none'}; top:{y}px; left:{x}px;">
</div>


<style>
    #context-menu {
        min-height: 100px;
        min-width: 100px;
        background: var(--modal-bg-color);
        position: absolute;
        z-index: 9999;
        border-radius: var(--small-radius);
        overflow-x: hidden;
        padding: .2rem 0;
        box-shadow: var(--small-shadow);
        vertical-align: middle;
        margin-left: .1rem;
        margin-top: -.5rem;
    }

</style>


<script>
    import g from '../lib/Globals'
    import ContextMenuRow from './ContextMenuRow.html'
    import ContextMenuDivider from './ContextMenuDivider.html'
    import EventDispatcherFactory from '../LayeredKeyboardControl/EventDispatcherFactory'

    export default {
        components: {},
        oncreate() {
            g.contextMenu = this
            this.rows = []
            this.dividers = []
            this.keyEventHandler = EventDispatcherFactory({
                target: this,
            })
        },
        onstate({ changed, current, previous }) {
            if (!previous) return
            if (changed.open) {
                this.set({
                    selectedRow: undefined
                })
                if (current.open) {
                    try {
                        g.activeEditor.completion.set({ open: false })
                    } catch (e) { /* do nothing */ }
                    g.pushFocus(this)
                } else {
                    g.popFocus(this)
                }
            }
            if (changed.items) {
                for (const i of this.rows)
                    i.destroy()
                for (const i of this.dividers)
                    i.destroy()
                this.rows.length = 0
                this.dividers.length = 0
                if (!current.items) return
                for (const i of current.items) {
                    if (i.divider) {
                        const child = new ContextMenuDivider({
                            target: this.refs.contextMenu,
                        })
                        this.dividers.push(child)
                    } else {
                        const child = new ContextMenuRow({
                            target: this.refs.contextMenu,
                            data: i
                        })
                        child.parent = this
                        this.rows.push(child)
                    }
                }
            }
            if (changed.selectedRow) {
                if (previous.selectedRow) previous.selectedRow.set({
                    selected: false
                })
                if (current.selectedRow) current.selectedRow.set({
                    selected: true
                })
            }
        },
        data() {
            return {
                items: [{
                    text: '',
                    callback: () => {}
                }],
                selectedRow: null,
                open: false,
                x: 0,
                y: 0,
                caller: null,
                closable: true,
            }
        },
        methods: {
            move(nRows) {
                const currentIndex = this.rows.indexOf(this.get().selectedRow)
                const length = this.rows.length

                let targetIndex = currentIndex + nRows
                if (currentIndex === -1 && nRows < 0) targetIndex = length - 1
                else if (targetIndex >= length) targetIndex = length - 1
                else if (targetIndex < 0) targetIndex = 0

                const targetRow = this.rows[targetIndex]
                this.set({
                    selectedRow: targetRow
                })
            },
            enter(rowNumber) {
                const row = rowNumber ? this.rows[rowNumber - 1] : this.get().selectedRow
                if (row) row.click()
                else this.set({
                    open: false
                })
            }
        }
    }

</script>
