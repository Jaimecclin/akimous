<div ref:codeEditor class="tab-view" style="display: {active ? 'block' : 'none'}" />
<Completion ref:completion></Completion>


<style>


</style>


<script>
    import g from '../lib/Globals'
    import WSClient from '../lib/WSClient'
    import CMEventDispatcher from './CMEventDispatcher'
    import registerCMCommands from './CMCommands'
    import RealtimeFormatter from './RealtimeFormatter'
    import Predictor from './completion/Predictor'
    import { getIconByFileName } from '../lib/FileTypeToIcon'
    import { onIdle } from '../lib/Utils'

    /* eslint-disable */
    import CodeMirror from 'codemirror'
    import python from '../lib/python'

    // CM modes
    import clike from 'codemirror/mode/clike/clike'
    import cmake from 'codemirror/mode/cmake/cmake'
    import coffeescript from 'codemirror/mode/coffeescript/coffeescript'
    import css from 'codemirror/mode/css/css'
    import django from 'codemirror/mode/django/django'
    import dockerfile from 'codemirror/mode/dockerfile/dockerfile'
    import fortran from 'codemirror/mode/fortran/fortran'
    import go from 'codemirror/mode/go/go'
    import htmlembedded from 'codemirror/mode/htmlembedded/htmlembedded'
    import htmlmixed from 'codemirror/mode/htmlmixed/htmlmixed'
    import javascript from 'codemirror/mode/javascript/javascript'
    import lua from 'codemirror/mode/lua/lua'
    import livescript from 'codemirror/mode/livescript/livescript'
    import markdown from 'codemirror/mode/markdown/markdown'
    import nginx from 'codemirror/mode/nginx/nginx'
    import perl from 'codemirror/mode/perl/perl'
    import php from 'codemirror/mode/php/php'
    import protobuf from 'codemirror/mode/protobuf/protobuf'
    import r from 'codemirror/mode/r/r'
    import ruby from 'codemirror/mode/ruby/ruby'
    import rust from 'codemirror/mode/rust/rust'
    import sass from 'codemirror/mode/sass/sass'
    import shell from 'codemirror/mode/shell/shell'
    import sql from 'codemirror/mode/sql/sql'
    import swift from 'codemirror/mode/swift/swift'
    import toml from 'codemirror/mode/toml/toml'
    import xml from 'codemirror/mode/xml/xml'
    import yaml from 'codemirror/mode/yaml/yaml'


    // CM addons
    import meta from 'codemirror/mode/meta'
    import matchbrackets from 'codemirror/addon/edit/matchbrackets'
    import closebrackets from 'codemirror/addon/edit/closebrackets'
    import comment from 'codemirror/addon/comment/comment'
    import activeline from 'codemirror/addon/selection/active-line'
    import foldcode from 'codemirror/addon/fold/foldcode'
    import foldgutter from 'codemirror/addon/fold/foldgutter'
    import indentFold from 'codemirror/addon/fold/indent-fold'
    import sublime from 'codemirror/keymap/sublime'

    import matchhighlighter from './match-highlighter'
    /* eslint-enable */

    registerCMCommands(CodeMirror)

    export default {
        components: {
            Completion: './completion/Completion.html'
        },
        oncreate() {
            this.parent = this.get().parent
            const { fileName } = this.get()
            this.tab = this.parent.tabBar.openTab(this, fileName, getIconByFileName(fileName))
            g.panelMiddle.pathToEditor[this.get().filePath.join('/')] = this

            const mode = CodeMirror.findModeByFileName(fileName)

            // Step 1: Connect to websocket and read file
            const readFile = new Promise(resolve => {
                let startTime = performance.now()
                this.shouldClose = false
                this.ws = new WSClient('ws://127.0.0.1:3179/editor')
                this.ws.addHandler('openFile', data => {
                    console.warn('transmission took', performance.now() - startTime)
                    resolve(data) // <-- exit here
                })
                this.ws.connect(() => {
                    this.ws.send({
                        cmd: 'openFile',
                        filePath: this.get().filePath
                    })
                })
            })

            // Step 2: Open editor
            const initializeCM = readFile.then(data => {
                this.cm = CodeMirror(this.refs.codeEditor, {
                    value: data.content,
                    mode: mode ? mode.mime : undefined,
                    theme: 'legato',
                    indentUnit: 4,
                    lineNumbers: true,
                    autofocus: true,
                    // addons
                    matchBrackets: true, // edit/matchbrackets
                    autoCloseBrackets: true, // edit/closebrackets
                    highlightSelectionMatches: { // search/match-highlighter
                        style: 'matchhighlight',
                        minChars: 1,
                        delay: 50,
                        wordsOnly: false,
                        annotateScrollbar: false,
                        showToken: false,
                        trim: false
                    },
                    styleActiveLine: true, // selection/active-line

                    foldGutter: true, // fold/foldgutter
                    gutters: ['padding-gutter', 'CodeMirror-foldgutter', 'CodeMirror-linenumbers'],

                    // keymap
                    // TODO: add sublime shortcuts
                    extraKeys: {
                        'Tab': 'indentMore',
                        'Shift-Tab': 'indentLess',
                        'Cmd-/': 'toggleCommentIndented',
                        'Cmd-Backspace': 'deleteLineAndGoLineEnd',
                        'Cmd-D': 'duplicateLine',
                        'Cmd-J': 'joinLines',
                        'Cmd-B': 'selectNextOccurrence',
                    }
                })
                this.mtime = data.mtime
            })

            // Step 3: Do the rest of things (about 20 ms)
            initializeCM.then(() => onIdle(() => {
                this.completion = this.refs.completion
                this.cm.refresh() // prevent CM occasionally shifts to the right

                this.predictor = new Predictor(this)
                // only enable predictor when the document is a Python file
                //                            if (this.mode.mode !== 'python') 
                //                                this.predictor.enabled = false
                this.realtimeFormatter = RealtimeFormatter(this, CodeMirror)
                this.cmEventDispatcher = new CMEventDispatcher(this)

                //                            this.completionEventDispatcher = new CompletionEventDispatcher(this)
                this.completion.bindReferences(this)
                this.ws.addHandler('saveFile-ok', data => {
                    this.markClean()
                    this.mtime = data.mtime
                    if (this.shouldClose)
                        g.panelMiddle.closeFile(this.get().filePath)
                })
                this.ws.addHandler('predict-result', data => {
                    this.predictor.receive(data)
                })

                // resolve Safari overscroll jitter issue
                const scroller = this.refs.codeEditor.getElementsByClassName('CodeMirror-scroll')[0]
                scroller.onwheel = e => {
                    if (e.deltaY <= 0) return
                    const scrollInfo = this.cm.getScrollInfo()
                    if (scrollInfo.top + scrollInfo.clientHeight >= scrollInfo.height) {
                        e.preventDefault()
                    }
                }

                // prompt to reload if modified by another program
                this.ws.addHandler('reload-ok', data => {
                    this.cm.setValue(data.content)
                    this.markClean()
                })
                this.ws.addHandler('mtime', data => {
                    if (this.mtime === data.mtime) return
                    this.mtime = data.mtime
                    g.notificationBar.show(
                        'question',
                        `The file "<b>${this.get().fileName}</b>" has been modified by another program. Do you want to reload it?`, [{
                            name: 'Reload',
                            callback: () => {
                                this.ws.send({
                                    cmd: 'reload'
                                })
                            }
                        }]
                    )
                })

                // prompt to reload if deleted or moved
                this.ws.addHandler('event-FileDeleted', () => {
                    g.notificationBar.show(
                        'question',
                        `The file "<b>${this.get().fileName}</b>" has been deleted or moved to another place. Do you want to close it?`, [{
                            name: 'Close',
                            callback: () => {
                                this.markClean()
                                g.panelMiddle.closeFile(this.get().filePath)
                            }
                        }]
                    )
                })

                this.ws.addHandler('findUsages-ok', data => {
                    const selections = []
                    for (const pos of data.pos) {
                        const [line, ch] = pos
                        const startPos = {
                            line,
                            ch
                        }
                        const token = this.cm.getTokenAt(startPos)
                        startPos.ch -= 1
                        const endPos = {
                            line,
                            ch: token.end
                        }
                        if (token.string !== data.token) {
                            console.warn('variable name not match', token.string, data.token)
                            continue
                        }
                        selections.push({
                            anchor: startPos,
                            head: endPos
                        })
                    }
                    this.cm.setSelections(selections)
                })

                this.ws.addHandler('getCompletionDocstring-result', data => {
                    this.completion.set({ docstring: data.result })
                })
            }), 500)
        },
        ondestroy() {
            this.tab.destroy()
            delete g.panelMiddle.pathToEditor[this.get().filePath.join('/')]
        },
        onstate({ changed, current, previous }) {
            if (changed.filePath) {
                const newPath = current.filePath
                g.panelMiddle.pathToEditor[newPath.join('/')] = this
                if (previous.filePath) {
                    delete g.panelMiddle.pathToEditor[previous.filePath.join('/')]
                    this.ws.send({
                        cmd: 'mtime',
                        newPath
                    })
                }
            }
            if (!this.tab) return
            if (changed.fileName) {
                this.tab.set({
                    name: current.fileName
                })
            }
            if (changed.clean) {
                this.tab.set({
                    clean: current.clean
                })
            }
            if (changed.active) {
                this.tab.set({
                    active: current.active
                })
            }
        },
        data() {
            return {
                fileName: '',
                filePath: null,
                active: false,
                clean: true
            }
        },
        methods: {
            save() {
                this.ws.send({
                    cmd: 'saveFile',
                    content: this.cm.getValue()
                })
            },
            insertText(text) {
                g.activeEditor && g.activeEditor.cm.hasFocus()
                if (g.activeEditor != this || !this.cm.hasFocus()) return
                this.cm.doc.replaceRange(text, this.cm.doc.getCursor('from'), this.cm.doc.getCursor('to'), '+input')
            },
            markClean() {
                this.set({
                    clean: true
                })
                this.cm.doc.markClean()
            }
        }
    }

</script>
