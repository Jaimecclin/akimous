<div ref:completion class="completion">
<!--
    
    {{#each rows as row}}
        <CompletionRow></CompletionRow>
    {{/each}}
-->
</div>


<style>
    .completion {
        background: var(--main-bg-color);
        color: var(--basic-monospace-font-color);
        height: 14rem;
        min-width: 24rem;
        z-index: 100;
        position: absolute;
        box-shadow: 0 .1rem 1rem .1rem rgba(0, 0, 0, .7);
        border-radius: .5rem;
        font-family: var(--basic-monospace-font-family);
        font-size: var(--basic-monospace-font-size);
        line-height: 2rem;

        overflow-x: scroll;
        cursor: default;
        user-select: none;
        -webkit-user-select: none;
    }

</style>


<script>
    import g from '../../lib/Globals'
    import CompletionRow from './CompletionRow.html'

    export default {
        components: {
//            CompletionRow
        },
        oncreate() {
//            this.isOpen = false
//            this.passive = false
            const completion = this.refs.completion
            this.selectedCompletion = undefined
            this.onClickHandler = (event) => {
                this.selectedCompletion = event.path[0]
                this.commit()
            }
            this.completionRows = []
            
            // keep row number of visible rows 1 to 7
            let lastFVI = 999
            const scrollHandler = () => {
                const rowHeight = this.completionRows[0].refs.completionRow.clientHeight
                let firstVisibleIndex = Math.floor(completion.scrollTop / rowHeight)
                if (firstVisibleIndex < 0) 
                    firstVisibleIndex = 0
                if (firstVisibleIndex > this.completionRows.length) 
                    firstVisibleIndex = this.completionRows.length - 1
                if (lastFVI === firstVisibleIndex) return
                let lastVisibleIndex = firstVisibleIndex + 8
                if (lastVisibleIndex > this.completionRows.length)
                    lastVisibleIndex = this.completionRows.length
                for (let i = firstVisibleIndex; i < lastVisibleIndex; i++) {
                    this.completionRows[i].set({
                        rowNumber: i - firstVisibleIndex + 1
                    })
                }
                lastFVI = firstVisibleIndex
            }
            completion.addEventListener('scroll', scrollHandler)
            
            
            this.observe('rows', rows => {
                for (const row of this.completionRows)
                    row.destroy()
                for (const row of rows) {
                    this.completionRows.push(new CompletionRow({
                        target: completion,
                        data: row
                    }))
                }
                lastFVI = 999
                scrollHandler()
            })
//            const test = new CompletionRow({
//                target: this.refs.completion,
//                
//            })
//            new CompletionRow({
//                target: this.refs.completion,
//                
//            })
//            this.renderCompletionLines = () => {
//                if (this.completionLinesToBeRendered === undefined) return
//                for (let i of this.completionLinesToBeRendered) {
//                    const el = document.createElement('div')
//                    el.classList.add('line')
//                    el.classList.add(i.t)
//                    el.id = 'c' + this.completionLineCounter++
//                        el.innerHTML = i.highlight
//                    el.onclick = this.onClickHandler
//                    el.type = i.t
//                    this.container.appendChild(el)
//                }
//            }
        },
        data() {
            return {
                open: false,
                passive: false,
                rows: [
                    {
                        text: 'aaaa',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                    {
                        text: 'bbbb',
                        type: 'function'
                    },
                ]
            }
        },
        methods: {
            shouldDisplayCompletion(c) {
                if (this.passive && c.c.length < 3) return false
                return c.sortScore > 0
            },
            bindReferences(editor) {
                this.cm = editor.cm
                this.predictor = editor.predictor
//                this.completion = editor.completion
            }
        }
    }

</script>
