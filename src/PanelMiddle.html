<div ref:panelMiddle id="panel-middle" class=" {{focused?'indicator-on':''}} ">
    <TabBar ref:tabBar id="tab-bar"></TabBar>
</div>


<style>
    #panel-middle {
        position: fixed;
        top: var(--toolbar-height);
        height: calc(100% - var(--toolbar-height));
        left: calc(var(--panel-left-width) + 1px);
        width: calc(100% - var(--panel-left-width) - var(--panel-right-width) - 1px);
        box-sizing: border-box;
    }

</style>


<script>
    import g from './lib/Globals'
    import TabBar from './panels/TabBar.html'
    import CodeEditor from './editor/CodeEditor.html'

    const MAX_ACTIVATION_HISTORY = 32

    export default {
        components: {
            TabBar
        },
        oncreate() {
            g.panelMiddle = this
            this.tabBar = this.refs.tabBar
            this.tabBar.set({
                parent: this
            })
            this.pathToEditor = {}
            this.activationHistory = new Array(MAX_ACTIVATION_HISTORY)
            this.activationHistoryIndex = 0
            setTimeout(() => {
                this.openFile(['demo', 'demo.py'], 'demo.py')
            }, 100)
        },
        onstate({ changed, current, previous }) {
            if (changed.focus) {
                const focus = current.focus
                if (focus === previous.focus) return
                if (!focus) g.setFocus([g.panelLeft, g.fileTree])
                else g.setFocus([this, focus])
                g.activeEditor = focus
            }
            if (changed.focused) {
                const editor = this.get().focus
                if (current.focused) {
                    editor && editor.cm && editor.cm.focus()
                } else
                    editor && editor.cm && editor.cm.getInputField().blur()
            }
        },
        data() {
            return {
                focus: null,
                focused: false,
            }
        },
        methods: {
            getEditor(filePath) {
                return this.pathToEditor[filePath.join('/')]
            },
            openFile(filePath, fileName) {
                let editor = this.getEditor(filePath)
                if (!editor) {
                    new CodeEditor({
                        target: this.refs.panelMiddle,
                        data: {
                            filePath,
                            fileName,
                            parent: this
                        }
                    })
                }
                this.activateFile(filePath)
            },
            activateView(editor) {
                this.activateFile(editor.get().filePath)
            },
            activateFile(filePath) {
                // write to activation history
                if (this.activationHistory[this.activationHistoryIndex] != filePath) {
                    this.activationHistoryIndex = (this.activationHistoryIndex + 1) % MAX_ACTIVATION_HISTORY
                    this.activationHistory[this.activationHistoryIndex] = filePath
                }
                // activate editor
                g.activeEditor && (g.activeEditor.set({
                    active: false
                }))
                const editor = this.getEditor(filePath)
                this.set({
                    focus: editor
                })
                if (!editor) return
                editor.set({
                    active: true
                })
                editor.cm && editor.cm.focus()
            },
            renameDir(newDirPath, oldDirPath) {
                const oldDirPathString = oldDirPath.join('/')
                for (const oldPathString in this.pathToEditor) {
                    if (oldPathString.indexOf(oldDirPathString) !== 0) continue
                    const editor = this.pathToEditor[oldPathString]
                    editor.set({
                        filePath: [...newDirPath, ...editor.get().filePath.slice(newDirPath.length)]
                    })
                }
            },
            closeView(editor) {
                this.closeFile(editor.get().filePath)
            },
            closeFile(filePath) {
                const editor = this.getEditor(filePath)
                // if the file has been edited, prompt for saving
                if (!editor.get().clean) {
                    // todo: close completion, blur editor
                    g.prompt.open({
                        icon: 'far fa-hdd',
                        content: `Do you want to save the changes you made in <em>${editor.get().fileName}</em> ?`,
                        buttons: [{
                            text: 'Don\'t Save',
                            style: 'danger',
                            action: () => {
                                editor.set({
                                    clean: true
                                })
                                this.closeFile(filePath)
                            }
                        }, {
                            text: 'Cancel',
                            style: 'dismiss',
                        }, {
                            text: 'Save',
                            style: 'success',
                            action: () => {
                                editor.save()
                                editor.shouldClose = true
                            }
                        }]
                    })
                    return
                }
                editor.destroy()

                // clear activation history
                for (let i = 0; i < MAX_ACTIVATION_HISTORY; i++)
                    if (this.activationHistory[i] === filePath)
                        this.activationHistory[i] = null
                // activate previous file
                for (let i = this.activationHistoryIndex; i > this.activationHistoryIndex - MAX_ACTIVATION_HISTORY; i--) {
                    const previouslyActivatedFilePath = this.activationHistory[i % MAX_ACTIVATION_HISTORY]
                    if (previouslyActivatedFilePath && this.getEditor(previouslyActivatedFilePath)) {
                        this.activateFile(previouslyActivatedFilePath)
                        return
                    }
                }
                // if history is exhausted, select the last editor
                let tabs = this.tabBar.refs.tabBar.getElementsByClassName('tab')
                if (tabs.length > 0) {
                    this.activateFile(tabs[tabs.length - 1].dataset.filepath)
                    return
                }
                // if no files opened, clear focus
                this.set({
                    focus: null
                })
            }
        }
    }

</script>
