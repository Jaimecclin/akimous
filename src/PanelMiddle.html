<div ref:panelMiddle id="panel-middle">
    <TabBar id="tab-bar"></TabBar>
</div>


<style>
    #panel-middle {
        position: fixed;
        top: var(--toolbar-height);
        height: calc(100% - var(--toolbar-height));
        left: calc(var(--panel-left-width) + 1px);
        width: calc(100% - var(--panel-left-width) - var(--panel-right-width) - 1px);
    }

</style>


<script>
    import g from './lib/Globals'
    import TabBar from './panels/TabBar.html'
    import CodeEditor from './editor/CodeEditor.html'

    const MAX_ACTIVATION_HISTORY = 32

    export default {
        components: {
            TabBar
        },
        oncreate() {
            g.panelMiddle = this
            this.pathToEditor = {} // /path/to/a/file.py -> <CodeEditor>
            this.activationHistory = new Array(MAX_ACTIVATION_HISTORY)
            this.activationHistoryIndex = 0
            setTimeout(() => {
                this.openFile('./demo/demo.py', 'demo.py')
            })
        },
        methods: {
            openFile: function(filePath, fileName) {
                let editor = this.pathToEditor[filePath]
                if (!editor) {
                    this.pathToEditor[filePath] = new CodeEditor({
                        target: this.refs.panelMiddle,
                        data: {
                            filePath,
                            fileName,
                            active: true
                        }
                    })
                    g.tabBar.openTab(filePath, fileName)
                }
                this.activateFile(filePath)
            },
            activateFile(filePath) {
                // write to activation history
                if (this.activationHistory[this.activationHistoryIndex] != filePath) {
                    this.activationHistoryIndex = (this.activationHistoryIndex + 1) % MAX_ACTIVATION_HISTORY
                    this.activationHistory[this.activationHistoryIndex] = filePath
                }
                g.tabBar.set({
                    activeFilePath: filePath
                })
                // activate editor
                g.activeEditor && (g.activeEditor.set({
                    active: false
                }))
                const editor = this.pathToEditor[filePath]
                g.activeEditor = editor
                if (!editor) return
                editor.set({
                    active: true
                })
                editor.cm && editor.cm.focus()
            },
            closeFile(filePath) {
                const editor = this.pathToEditor[filePath]
                // if the file has been edited, prompt for saving
                if (!editor.clean) {
                    g.prompt.open({
                        icon: 'fa fa-hdd-o',
                        content: `Do you want to save the changes you made in <em>${editor.get('fileName')}</em> ?`,
                        buttons: [{
                            text: `Don't Save`,
                            style: 'danger',
                            action: () => {
                                console.log('fuck')
                                editor.clean = true
                                this.closeFile(filePath)
                            }
                        }, {
                            text: `Cancel`,
                            style: 'dismiss',
                        }, {
                            text: `Save`,
                            style: 'success',
                            action: () => {
                                editor.save()
                                editor.shouldClose = true
                            }
                        }]
                    })
                    return
                }
                g.activeEditor = undefined
                g.tabBar.closeTab(filePath)
                editor.destroy()
                delete this.pathToEditor[filePath]

                // clear activation history
                for (var i = 0; i < MAX_ACTIVATION_HISTORY; i++)
                    if (this.activationHistory[i] === filePath)
                        this.activationHistory[i] = undefined
                // activate previous file
                for (var i = this.activationHistoryIndex; i > this.activationHistoryIndex - MAX_ACTIVATION_HISTORY; i--) {
                    const previouslyActivatedFilePath = this.activationHistory[i % MAX_ACTIVATION_HISTORY]
                    if (previouslyActivatedFilePath != undefined) {
                        this.activateFile(previouslyActivatedFilePath)
                        return
                    }
                }
                // if history is exhausted, select the last editor
                let tabs = g.tabBar.refs.tabBar.getElementsByClassName('tab')
                if (tabs.length > 0) {
                    this.activateFile(tabs[tabs.length - 1].dataset.filepath)
                }
            }
        }
    }

</script>
