<div ref:fileTree class="file-tree">
    <div class="container" ref:children>
        {{#each dirs as i @id}}
        <FileTreeNode item={{i}} parent={{self}} isFolder></FileTreeNode>
        {{/each}} {{#each files as i @id}}
        <FileTreeNode item={{i}} parent={{self}}></FileTreeNode>
        {{/each}}
    </div>
</div>

<style>
    .file-tree {
        width: 100%;
        height: calc(100% - .8rem);
        padding: .4rem 0;
        color: var(--basic-ui-font-color);
        font-family: var(--basic-ui-font-family);
        font-size: var(--basic-ui-font-size);
        -webkit-font-smoothing: subpixel-antialiased;
        user-select: none;
        -webkit-user-select: none;
        overflow-x: scroll;
    }

    .container {
        min-width: 100%;
        display: inline-block;
    }

</style>


<script>
    import g from '../lib/Globals'
    import WSClient from '../lib/WSClient'
    import FileTreeNode from './FileTreeNode.html'

    export default {
        components: {
            FileTreeNode
        },
        oncreate() {
            g.fileTree = this
            this.set({
                self: this
            })
//            this.openedFolders = {}
            this.allNodes = {}

            this.ws = new WSClient('ws://127.0.0.1:3179/fileTree')
            this.ws.addHandler('openFolder-ok', data => {
//                let target = this.openedFolders[data.path]
                let target = this.allNodes[data.path]
                if (!target) {
                    target = this
//                    this.openedFolders = {}
                    this.allNodes = {}
                }

                data.dirs.forEach(x => x.id = g.uid)
                data.files.forEach(x => x.id = g.uid)
                target.set({
                    dirs: data.dirs.sort((a, b) => a.name > b.name),
                    files: data.files.sort((a, b) => a.name > b.name)
                })
            })
            this.ws.addHandler('rename-ok', data => {
                //                const tab = g.tabBar.pathToTab[data.oldPath]
                //                if (!tab) return
                //                tab.set({
                //                    filePath: data.newPath,
                //                    fileName: data.newName
                //                })
                //                const editor = g.panelMiddle.pathToEditor[data.oldPath]
                //                editor.set({
                //                    filePath: data.newPath,
                //                    fileName: data.newName
                //                })
            })
            const renamingEventHandler = data => {
                console.log('renamingEventHandler', data)
                // change file tree names
                const node = this.allNodes[data.srcPath]
                console.warn(this.allNodes, data.srcPath, data.destPath)
                const item = node.get('item')
                item.name = data.newName
                item.path = data.destPath
                node.set({
                    item
                })
                node.get('parent').redraw()

                // change paths to opened files
                if (data.cmd === 'event-FileRenamed') {
                    g.panelMiddle.renameDir(data.destPath, data.srcPath)
                    g.tabBar.renameFile(data.destPath, data.newName)
                } else if (data.cmd === 'event-DirRenamed') {
                    g.panelMiddle.renameDir(data.destPath, data.srcPath)
                }
            }
            this.ws.addHandler('event-FileRenamed', renamingEventHandler)
            this.ws.addHandler('event-DirRenamed', data => {
                // change file tree names
                const node = this.allNodes[data.srcPath]
                const item = node.get('item')
                item.name = data.newName
                item.path = data.destPath
                node.set({
                    item
                })
                node.get('parent').redraw()

                // change paths to opened files
                g.panelMiddle.renameDir(data.destPath, data.srcPath)
            })

            this.ws.connect(() => {
                this.ws.send({
                    cmd: 'openFolder',
                    path: this.get('path'),
                })
            })
        },
        data() {
            return {
                path: '.',
                dirs: [],
                files: [],
                self: this
            }
        },
        methods: {
            redraw() {
                this.set({
                    dirs: this.get('dirs').sort((a, b) => a.name > b.name),
                    files: this.get('files').sort((a, b) => a.name > b.name)
                })
            }
        }
    }

</script>
