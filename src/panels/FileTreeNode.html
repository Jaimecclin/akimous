<div ref:row on:mousedown="onClick()" on:dblclick="onDoubleClick()" on:contextmenu="onContextMenu(event)" class="file-tree-node {{selected?'selected':''}}" style="padding-left: {{0.3 + level}}rem;">
    <span class="icon {{icon}}"></span> {{#if !renaming}}
    <span class="display-name"> 
        {{name}}
    </span> 
    {{#if newfileing}}
    <span class="icon {{icon}}"></span>
    <input ref:input id="inputNewfileName" type="text" value="" on:blur="commitNewfile()"> {{/if}}
    {{else}}
    <input ref:input class="input.display-name" type="text" value="{{name}}" on:blur="commitRename()" > {{/if}}

</div>
<div ref:children>
    {{#each dirs as i @uid}}
    <:Self level={{level+1}} name={{i.name}} parent={{self}} isFolder/> {{/each}} {{#each files as i @uid}}
    <:Self level={{level+1}} name={{i.name}} parent={{self}} /> {{/each}}
    
    {{#if newfileing}}
    <!-- <:Self name="" parent={{self}} /> -->
    <div style="padding-left: {{0.3 + level + 1}}rem; display: inline-block;" >
        <span class="icon {{icon}}"></span>
        <input ref:input id="inputNewfileName" type="text" value="" on:blur="commitNewfile()" >
    </div>{{/if}}
</div>


<style>
    .file-tree-node {
        height: var(--basic-ui-line-height);
        line-height: var(--basic-ui-line-height);
        cursor: default;
        white-space: nowrap;
        min-width: 100%;
        font-size: var(--basic-ui-font-size);
    }

    .file-tree-node.selected {
        background: var(--ui-highlight-color);
        color: white;
    }

    .file-tree-node:hover {
        color: white;
    }

    .icon {
        width: 1rem;
        min-height: 1rem;
        display: inline-block;
        vertical-align: text-bottom;
        background-size: 100% 100% !important;
    }

    .display-name {
        padding-left: 0.3rem;
        vertical-align: middle;
    }

    input.display-name {
        border-radius: var(--small-radius);
        font-size: var(--basic-ui-font-size);
        height: var(--basic-ui-font-size);
    }

</style>


<script>
    import g from '../lib/Globals'
    import {
        fileTypeToIcon,
        defaultIcon,
        folderIcon,
        folderOpenIcon
    } from '../lib/FileTypeToIcon'
    import pressure from 'pressure'

    const contextMenu = [{
        text: 'New File',
        icon: 'far fa-file',
        callback: (target) => {
            console.log('new file clicked')
            target.newfile()
        }
    }, {
        text: 'New Folder',
        icon: 'fas fa-folder',
        callback: () => {}
    }, {
        text: 'New Python Module',
        icon: 'fas fa-cube',
        callback: () => {}
    }, {
        divider: true
    }, {
        text: 'Rename',
        icon: 'fas fa-pen-square',
        callback: (target) => {
            target.rename()
        }
    }, {
        text: 'Delete',
        icon: 'fas fa-trash',
        callback: () => {}
    }, {
        text: 'Show in File Manager',
        icon: 'fas fa-external-link-alt',
        callback: () => {}
    }, {
        text: 'Copy Path',
        icon: 'fas fa-link',
        callback: () => {}
    }]

    export default {
        components: {},
        oncreate() {
            this.children = {}
            this.observe('name', (newValue, oldValue) => {
                const parent = this.get('parent')
                if (oldValue) delete parent.children[oldValue]
                parent.children[newValue] = this
            })

            // set icon
            const name = this.get('name')
            let icon
            if (this.get('isFolder')) {
                icon = fileTypeToIcon['folder']
            } else {
                try {
                    const fileType = name.substring(name.lastIndexOf('.') + 1)
                    icon = fileTypeToIcon[fileType]
                    if (!icon) icon = defaultIcon
                } catch (e) {
                    icon = defaultIcon
                }
            }
            this.set({
                icon,
                self: this
            })

            // register folder
            if (this.get('isFolder')) {
                this.observe('open', open => {
                    if (open) {
                        this.set({
                            icon: fileTypeToIcon['folder-open']
                        })
                    } else {
                        this.set({
                            icon: fileTypeToIcon['folder']
                        })
                    }
                }, {
                    init: false
                })
            }

            g.fileTree.on('cancelAllSelection', () => {
                this.set({
                    selected: false
                })
            })

            // todo: find a way to move event handler outside
            pressure.set(this.refs.row, {
                startDeepPress: e => {
                    this.rename()
                }
            })
        },
        ondestroy() {
            this.removeChildren()
        },
        data() {
            return {
                name: '',
                icon: '',
                level: 0,
                isFolder: false,
                open: false,
                selected: false,
                renaming: false,
                newfileing: false,
                // children
                dirs: [],
                files: [],
                self: this,
                parent: undefined,
            }
        },
        methods: {
            getPath() {
                const path = [this.get('name')]
                let node = this.get('parent'),
                    name
                while (name = node.get('name')) {
                    path.push(name)
                    node = node.get('parent')
                }
                return path.reverse()
            },
            onClick() {
                const selected = this.get('selected')
                if (!selected) {
                    g.fileTree.fire('cancelAllSelection')
                }
                this.set({
                    selected: !selected
                })
            },
            onDoubleClick() {
                if (this.get('isFolder')) {
                    this.set({
                        open: !this.get('open')
                    })
                    if (this.get('open')) {
                        g.fileTree.ws.send({
                            cmd: 'openFolder',
                            path: this.getPath(),
                        })
                    } else {
                        this.set({
                            files: [],
                            dirs: []
                        })
                        g.fileTree.ws.send({
                            cmd: 'closeFolder',
                            path: this.getPath()
                        })
                    }
                } else {
                    g.panelMiddle.openFile(this.getPath(), this.get('name'))
                }

            },
            onContextMenu(e) {
                g.fileTree.fire('cancelAllSelection')
                this.set({
                    selected: true
                })
                g.contextMenu.set({
                    open: true,
                    x: e.clientX,
                    y: e.clientY,
                    items: contextMenu,
                    caller: this
                })
                e.preventDefault()
            },
            redraw() {
                this.set({
                    dirs: this.get('dirs').sort((a, b) => a.name > b.name),
                    files: this.get('files').sort((a, b) => a.name > b.name)
                })
            },
            removeChildren() {
                this.set({
                    dirs: [],
                    files: []
                })
            },
            rename() {
                this.set({
                    renaming: true
                })
                this.refs.input.focus()
                this.refs.input.onkeydown = e => {
                    if (e.key === 'Enter')
                        this.refs.input.blur()
                    else if (e.key === 'Escape')
                        this.set({
                            renaming: false
                        })
                    else return true
                    e.preventDefault()
                    e.stopPropagation()
                    return false
                }
            },
            commitRename() {
                if (this.refs.input.value !== this.get('name') && this.refs.input.value.length > 0)
                    g.fileTree.ws.send({
                        cmd: 'rename',
                        path: this.getPath(),
                        newName: this.refs.input.value
                    })
                this.set({
                    renaming: false
                })
            },
            newfile() {
                this.set({
                    newfileing: true
                })
                this.refs.input.focus()
                this.refs.input.onkeydown = e => {
                    if (e.key === 'Enter')
                        this.refs.input.blur()
                    else if (e.key === 'Escape')
                        this.set({
                            newfileing: false
                        })
                    else return true
                    e.preventDefault()
                    e.stopPropagation()
                    return false
                }
            },
            commitNewfile() {
                var name_element = document.getElementById('inputNewfileName');
                var name = name_element.value;
                if (name != '')
                    g.fileTree.ws.send({
                        cmd: 'newfile',
                        path: this.getPath(),
                        newfileName: name //send newfile name
                    })
                this.set({
                    newfileing: false
                })
                //TODO: focus on new file
            }
        }
    }

</script>
